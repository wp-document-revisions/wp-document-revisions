(()=>{"use strict";class e{constructor(e){this.hasUpload=!1,this.$=e,this.secure="https:"===window.location.protocol,this.window=window.dialogArguments||window.opener||window.parent||window.top,this.initializeEvents(),this.initializeUI(),this.hijackAutosave(),setInterval(()=>this.updateTimestamps(),6e4)}initializeEvents(){const e=(e,t,i)=>{const o=this.$(e);o&&"function"==typeof o.on&&o.on(t,i)};e(".revision","click",this.restoreRevision.bind(this)),e("#override_link","click",this.overrideLock.bind(this)),e("#document a","click",this.requestPermission.bind(this)),e(document,"autosaveComplete",this.postAutosaveCallback.bind(this)),e(document,"documentUpload",this.legacyPostDocumentUpload.bind(this)),e("#misc-publishing-actions a","click",this.enableSubmit.bind(this)),e("input, select","change",this.enableSubmit.bind(this)),e("input[type=text], textarea","keyup",this.enableSubmit.bind(this)),e("#content-add_media","click",this.cookieFalse.bind(this)),e("#postimagediv .inside","click",this.cookieTrue.bind(this)),e("#submitdiv .inside","click",this.cookieDelete.bind(this)),e("#adminmenumain","click",this.cookieDelete.bind(this)),e("#wpadminbar","click",this.cookieDelete.bind(this))}initializeUI(){const e=this.$(":button, :submit","#submitpost");e&&"function"==typeof e.prop&&e.prop("disabled",!0);const t=e=>{const t=this.$(e);t&&"function"==typeof t.show&&t.show()};t("#document"),t("#revision-log"),(()=>{const e=this.$("#revision-summary");e&&"function"==typeof e.hide&&e.hide()})(),this.bindPostDocumentUploadCallback()}hijackAutosave(){if("function"==typeof window.autosave){const e=window.autosave_enable_buttons;e&&(window.autosave_enable_buttons=()=>{this.$(document).trigger("autosaveComplete"),this.hasUpload&&e()})}}enableSubmit(){this.$("#revision-summary").show(),this.$(":button, :submit","#submitpost").removeAttr("disabled")}restoreRevision(e){e.preventDefault();const t=this.$(e.target).attr("href");t&&confirm(window.wp_document_revisions.restoreConfirmation)&&(window.location.href=t)}overrideLock(){this.$.post(window.ajaxurl,{action:"override_lock",post_id:this.$("#post_ID").val()||0,nonce:window.wp_document_revisions.nonce}).done(e=>{e?(this.$("#lock_override").hide(),this.$(".error").not("#lock-notice").hide(),this.$("#publish, .add_media, #lock-notice").fadeIn(),"function"==typeof window.autosave&&window.autosave()):alert(window.wp_document_revisions.lockError)}).fail(()=>{alert(window.wp_document_revisions.lockError)})}requestPermission(){"Notification"in window&&Notification.requestPermission()}lockOverrideNotice(e){"Notification"in window?"default"===Notification.permission?Notification.requestPermission().then(t=>{"granted"===t?this.lockOverrideNotice(e):alert(e)}):"granted"===Notification.permission?new Notification(window.wp_document_revisions.lostLockNoticeTitle,{body:e,icon:window.wp_document_revisions.lostLockNoticeLogo}):alert(e):alert(e)}postAutosaveCallback(){if(this.$("#autosave-alert").length>0&&this.$("#lock-notice").length>0&&this.$("#lock-notice").is(":visible")){const e=this.$("#title").val()||"",t=window.wp_document_revisions.lostLockNotice.replace("%s",e);this.lockOverrideNotice(t),location.reload()}}legacyPostDocumentUpload(){console.warn("Legacy post document upload event triggered")}cookieFalse(){window.wpCookies.set("doc_image","false",86400,!1,!1,this.secure,"strict")}cookieTrue(){window.wpCookies.set("doc_image","true",86400,!1,!1,this.secure,"strict"),this.$(":button, :submit","#submitpost").removeAttr("disabled")}cookieDelete(){window.wpCookies.set("doc_image","true",-1,!1,!1,this.secure,"strict"),this.$(":button, :submit","#submitpost").removeAttr("disabled")}updateTimestamps(){this.$(".timestamp").each((e,t)=>{const i=this.$(t),o=i.attr("id");o&&i.text(this.humanTimeDiff(o))})}humanTimeDiff(e){const t=(new Date).getTime(),i=new Date(e).getTime(),o=Math.abs(t-i)/1e3,s=[{label:"year",seconds:31536e3},{label:"month",seconds:2592e3},{label:"week",seconds:604800},{label:"day",seconds:86400},{label:"hour",seconds:3600},{label:"minute",seconds:60}];for(const e of s){const t=Math.floor(o/e.seconds);if(t>=1)return`${t} ${e.label}${1!==t?"s":""} ago`}return"just now"}bindPostDocumentUploadCallback(){window.uploader&&window.uploader.bind("FileUploaded",(e,t,i)=>{i.response.match("media-upload-error")||this.postDocumentUpload(t.name,i.response)})}postDocumentUpload(e,t){if("string"==typeof t&&-1!==t.indexOf("error"))return void this.$(".media-item:first").html(t);if("object"==typeof e&&e.name,this.hasUpload)return;jQuery("#content").val(t),jQuery("#message").hide(),jQuery("#revision-summary").show(),jQuery(":button, :submit","#submitpost").removeAttr("disabled"),this.hasUpload=!0,window.tb_remove&&window.tb_remove();let i=window.wp_document_revisions.postUploadNotice;"function"==typeof window.convertEntities&&(i=window.convertEntities(i)),jQuery("#post").before(i).prev().fadeIn().fadeOut().fadeIn();const o=jQuery("#sample-permalink");if(o.length>0){const e=o.html().replace(/\<\/span>(\.[A-Za-z0-9]{1,7})?$/i,window.wp_document_revisions.extension);o.html(e)}}onUploadSuccess(e,t,i){try{const e="string"==typeof i?.response?i.response:i;this.postDocumentUpload(t,e)}catch(e){}}onUploadError(e,t,i){alert("string"==typeof i?i:i?.response||"Upload failed")}}jQuery(document).ready(t=>{window.WPDocumentRevisions=new e(t)})})();
//# sourceMappingURL=wp-document-revisions.js.map