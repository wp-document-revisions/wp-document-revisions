class WPDocumentRevisions{constructor(t){this.$=t,this.hasUpload=!1,this.secure="https:"===window.location.protocol,this.window=window.dialogArguments||opener||parent||top||window,this.restoreRevision=this.restoreRevision.bind(this),this.overrideLock=this.overrideLock.bind(this),this.enableSubmit=this.enableSubmit.bind(this),this.autosaveEnableButtons=this.autosaveEnableButtons.bind(this),this.hijackAutosave=this.hijackAutosave.bind(this),this.postAutosaveCallback=this.postAutosaveCallback.bind(this),this.updateTimestamps=this.updateTimestamps.bind(this),this.cookieFalse=this.cookieFalse.bind(this),this.cookieTrue=this.cookieTrue.bind(this),this.cookieDelete=this.cookieDelete.bind(this),this.buildContent=this.buildContent.bind(this),this.checkUpdate=this.checkUpdate.bind(this),this.init()}init(){this.$(".revision").click(this.restoreRevision),this.$("#override_link").click(this.overrideLock),this.$("#document a").click(this.requestPermission),this.$(document).bind("autosaveComplete",this.postAutosaveCallback),this.$(document).bind("documentUpload",this.legacyPostDocumentUpload.bind(this)),this.$(":button, :submit","#submitpost").prop("disabled",!0),this.$("#misc-publishing-actions a").click(this.enableSubmit),this.$("#sample-permalink").on("change",this.enableSubmit),this.$("input[type=text], textarea").on("keyup",this.enableSubmit),this.$("input, select").on("change",this.enableSubmit),this.$("#content-add_media").click(this.cookieFalse),this.$("#postimagediv .inside").click(this.cookieTrue),this.$("#publishing-action").click(this.buildContent),this.$("#submitdiv .inside").click(this.cookieDelete),this.$("#adminmenumain").click(this.cookieDelete),this.$("#wpadminbar").click(this.cookieDelete),this.$("#document").show(),this.$("#revision-log").show(),this.$("#revision-summary").hide(),this.bindPostDocumentUploadCB(),this.hijackAutosave(),this.checkUpdate(),setInterval(this.updateTimestamps,6e4),setInterval(this.checkUpdate,1e3)}hijackAutosave(){this.autosaveEnableButtonsOriginal=window.autosave_enable_buttons,window.autosave_enable_buttons=this.autosaveEnableButtons}autosaveEnableButtons(){if(this.window.document.$(document).trigger("autosaveComplete"),this.hasUpload)return this.autosaveEnableButtonsOriginal()}enableSubmit(){this.$("#revision-summary").show(),this.$(":button, :submit","#submitpost").removeAttr("disabled"),this.$("#lock_override").prev().fadeIn()}restoreRevision(t){t.preventDefault(),confirm(wp_document_revisions.restoreConfirmation)&&(window.location.href=this.$(t.target).attr("href"))}overrideLock(){return this.$.post(ajaxurl,{action:"override_lock",post_id:this.$("#post_ID").val()||0,nonce:wp_document_revisions.nonce},t=>{t?(this.$("#lock_override").hide(),this.$(".error").not("#lock-notice").hide(),this.$("#publish, .add_media, #lock-notice").fadeIn(),autosave()):alert(wp_document_revisions.lockError)})}requestPermission(){"Notification"in window?"granted"!==Notification.permission&&"denied"!==Notification.permission&&Notification.requestPermission():console.warn("This browser does not support notifications.")}lockOverrideNotice(t){const{lostLockNoticeTitle:i,lostLockNoticeLogo:e}=wp_document_revisions;"Notification"in window?"granted"===Notification.permission?new Notification(i,{body:t,icon:e}):"denied"!==Notification.permission&&Notification.requestPermission().then(o=>{"granted"===o&&new Notification(i,{body:t,icon:e})}):console.warn("This browser does not support desktop notification")}postAutosaveCallback(){this.$("#autosave-alert").length>0&&this.$("#lock-notice").length>0&&this.$("#lock-notice").is(":visible")&&(wp_document_revisions.lostLockNotice=wp_document_revisions.lostLockNotice.replace("%s",this.$("#title").val()),"Notification"in window&&"granted"===Notification.permission?this.lockOverrideNotice(wp_document_revisions.lostLockNotice):alert(wp_document_revisions.lostLockNotice),location.reload(!0))}legacyPostDocumentUpload(t,i){return this.postDocumentUpload(t,i)}humanTimeDiff(t,i){const e=new Date;i=i||e.getTime()/1e3+parseInt(wp_document_revisions.offset);const o=Math.abs(i-t);if(o<=3600){let t=Math.floor(o/60);return t=this.roundUp(t),1===t?wp_document_revisions.minute.replace("%d",t):wp_document_revisions.minutes.replace("%d",t)}if(o<=86400&&o>3600){let t=Math.floor(o/3600);return t=this.roundUp(t),1===t?wp_document_revisions.hour.replace("%d",t):wp_document_revisions.hours.replace("%d",t)}if(o>=86400){let t=Math.floor(o/86400);return t=this.roundUp(t),1===t?wp_document_revisions.day.replace("%d",t):wp_document_revisions.days.replace("%d",t)}}roundUp(t){return t<1&&(t=1),t}bindPostDocumentUploadCB(){"undefined"!=typeof uploader&&null!==uploader&&uploader.bind("FileUploaded",(t,i,e)=>{e.response.match("media-upload-error")||this.postDocumentUpload(i.name,e.response)})}cookieFalse(){wpCookies.set("doc_image","false",3600,"/wp-admin; SameSite=Strict",!1,this.secure)}cookieTrue(){wpCookies.set("doc_image","true",3600,"/wp-admin; SameSite=Strict",!1,this.secure),this.$(":button, :submit","#submitpost").removeAttr("disabled")}cookieDelete(){wpCookies.set("doc_image","true",-60,"/wp-admin; SameSite=Strict",!1,this.secure)}updateTimestamps(){this.$(".timestamp").each((t,i)=>{const e=this.$(i);e.text(this.humanTimeDiff(e.attr("id")))})}getDescr(){const t=this.window.document.getElementById("content_ifr");if(null===t){const t=this.$("#post_content").val();return void 0===t||""===t||/^\d+$/.test(t)?"":t}let i=t.contentWindow.document.getElementById("tinymce").innerHTML;if(void 0===i){const t=this.$("#post_content").val();return""===t||/^\d+$/.test(t)?"":t}return i=i.replace(/<br data-mce-bogus="1">/g,""),i=i.replace(/<br><\/p>/g,"</p>"),i=i.replace(/<p>\s*<\/p>/g,""),i}buildContent(){const t=this.$("#post_content").val();let i,e=this.getDescr();i=""===t?[""]:/^\d+$/.test(t)?[`\x3c!-- WPDR ${t} --\x3e`]:t.match(/<!-- WPDR \s*\d+ -->/),e=e.replace(/<!-- WPDR \s*\d+ -->/,""),e=i[0]+e,t!==e&&this.enableSubmit(),this.window.jQuery("#curr_content").val(e),this.window.jQuery("#post_content").val(e),this.window.jQuery("#content").val(e)}postDocumentUpload(t,i){if("string"==typeof i&&-1!==i.indexOf("error"))return this.$(".media-item:first").html(i);if(t instanceof Object&&(t=t.name.split(".").pop()),this.hasUpload)return;const e=/\d+$/.exec(i);return this.window.jQuery("#post_content").val(`\x3c!-- WPDR ${e} --\x3e`),this.window.jQuery("#message").hide(),this.hasUpload=!0,this.window.tb_remove(),this.window.jQuery("#post").before(wp_document_revisions.postUploadNotice).prev().fadeIn().fadeOut().fadeIn(),this.enableSubmit(),0!==this.window.jQuery("#sample-permalink").length?this.window.jQuery("#sample-permalink").html(this.window.jQuery("#sample-permalink").html().replace(/\<\/span>(\.[a-z0-9]{1,7})?@$/i,wp_document_revisions.extension)):void 0}checkUpdate(){const t=this.$("#curr_content").val();if(void 0===t)return;const i=this.$("#post_content").val();if("Unset"===t)return this.$(":button, :submit","#submitpost").prop("disabled",!0),void this.$("#curr_content").val(i);this.getDescr()===t&&i===t||(this.buildContent(),this.enableSubmit())}}jQuery(t=>{window.WPDocumentRevisions=new WPDocumentRevisions(t)});