!function(){"use strict";class t{constructor(t){this.$=t,this.hasUpload=!1,this.secure="https:"===window.location.protocol,this.window=window.dialogArguments||window.opener||window.parent||window.top,this.$(".revision").click(t=>this.restoreRevision(t)),this.$("#override_link").click(()=>this.overrideLock()),this.$("#document a").click(()=>this.requestPermission()),this.$(document).bind("autosaveComplete",()=>this.postAutosaveCallback()),this.$(document).bind("documentUpload",(t,e)=>this.legacyPostDocumentUpload(t,e)),this.$(":button, :submit","#submitpost").prop("disabled",!0),this.$("#misc-publishing-actions a").click(()=>this.enableSubmit()),this.$("input, select").on("change",()=>this.enableSubmit()),this.$("input[type=text], textarea").on("keyup",()=>this.enableSubmit()),this.$("#sample-permalink").on("change",()=>this.enableSubmit()),this.$("#content-add_media").click(()=>this.cookieFalse()),this.$("#postimagediv .inside").click(()=>this.cookieTrue()),this.$("#publishing-action").click(()=>this.buildContent()),this.$("#submitdiv .inside").click(()=>this.cookieDelete()),this.$("#adminmenumain").click(()=>this.cookieDelete()),this.$("#wpadminbar").click(()=>this.cookieDelete()),this.$("#document").show(),this.$("#revision-log").show(),this.$("#revision-summary").hide(),this.bindPostDocumentUploadCB(),this.hijackAutosave(),this.checkUpdate(),setInterval(()=>this.updateTimestamps(),6e4),setInterval(()=>this.checkUpdate(),1e3)}hijackAutosave(){this.autosaveEnableButtonsOriginal=window.autosave_enable_buttons,window.autosave_enable_buttons=()=>this.autosaveEnableButtons()}autosaveEnableButtons(){this.window.document.$(document).trigger("autosaveComplete"),this.hasUpload&&this.autosaveEnableButtonsOriginal()}enableSubmit(){this.$("#revision-summary").show(),this.$(":button, :submit","#submitpost").removeAttr("disabled"),this.$("#lock_override").prev().fadeIn()}restoreRevision(t){t.preventDefault(),confirm(wp_document_revisions.restoreConfirmation)&&(window.location.href=this.$(t.target).attr("href"))}overrideLock(){this.$.post(ajaxurl,{action:"override_lock",post_id:this.$("#post_ID").val()||0,nonce:wp_document_revisions.nonce},t=>{t?(this.$("#lock_override").hide(),this.$(".error").not("#lock-notice").hide(),this.$("#publish, .add_media, #lock-notice").fadeIn(),autosave()):alert(wp_document_revisions.lockError)})}requestPermission(){window.webkitNotifications&&window.webkitNotifications.requestPermission()}lockOverrideNotice(t){window.webkitNotifications.checkPermission()>0?window.webkitNotifications.RequestPermission(()=>this.lockOverrideNotice(t)):window.webkitNotifications.createNotification(wp_document_revisions.lostLockNoticeLogo,wp_document_revisions.lostLockNoticeTitle,t).show()}postAutosaveCallback(){if(this.$("#autosave-alert").length>0&&this.$("#lock-notice").length>0&&this.$("#lock-notice").is(":visible")){const t=wp_document_revisions.lostLockNotice.replace("%s",this.window.document.$("#title").val());window.webkitNotifications?this.lockOverrideNotice(t):alert(t),location.reload(!0)}}legacyPostDocumentUpload(t,e){this.postDocumentUpload(t,e)}human_time_diff(t,e){const i=new Date;e=e||i.getTime()/1e3+parseInt(wp_document_revisions.offset,10);const o=Math.abs(e-t);if(o<=3600){let t=Math.floor(o/60);return t=this.roundUp(t),1===t?wp_document_revisions.minute.replace("%d",t):wp_document_revisions.minutes.replace("%d",t)}if(o<=86400&&o>3600){let t=Math.floor(o/3600);return t=this.roundUp(t),1===t?wp_document_revisions.hour.replace("%d",t):wp_document_revisions.hours.replace("%d",t)}if(o>=86400){let t=Math.floor(o/86400);return t=this.roundUp(t),1===t?wp_document_revisions.day.replace("%d",t):wp_document_revisions.days.replace("%d",t)}}roundUp(t){return t<1?1:t}bindPostDocumentUploadCB(){"undefined"!=typeof uploader&&null!==uploader&&uploader.bind("FileUploaded",(t,e,i)=>{i.response.match("media-upload-error")||this.postDocumentUpload(e.name,i.response)})}cookieFalse(){wpCookies.set("doc_image","false",3600,"/wp-admin",!1,this.secure)}cookieTrue(){wpCookies.set("doc_image","true",3600,"/wp-admin",!1,this.secure),this.$(":button, :submit","#submitpost").removeAttr("disabled")}cookieDelete(){wpCookies.set("doc_image","true",-60,"/wp-admin",!1,this.secure)}updateTimestamps(){this.$(".timestamp").each((t,e)=>{this.$(e).text(this.human_time_diff(this.$(e).attr("id")))})}getDescr(){const t=this.window.document.getElementById("content_ifr");if(null===t){const t=this.$("#post_content").val();return void 0===t||""===t||/^\d+$/.test(t)?"":t}let e=t.contentWindow.document.getElementById("tinymce").innerHTML;if(void 0===e){const t=this.$("#post_content").val();return""===t||/^\d+$/.test(t)?"":t}return e=e.replace(/<br data-mce-bogus="1">/g,""),e=e.replace(/<br><\/p>/g,"</p>"),e=e.replace(/<p>\s*<\/p>/g,""),e}buildContent(){const t=this.$("#post_content").val();let e,i=this.getDescr();e=""===t?[""]:/^\d+$/.test(t)?[`\x3c!-- WPDR ${t} --\x3e`]:t.match(/<!-- WPDR \s*\d+ -->/),i=i.replace(/<!-- WPDR \s*\d+ -->/,""),i=e[0]+i,t!==i&&this.enableSubmit(),this.window.jQuery("#curr_content").val(i),this.window.jQuery("#post_content").val(i),this.window.jQuery("#content").val(i)}postDocumentUpload(t,e){if("string"==typeof e&&-1!==e.indexOf("error"))return void this.$(".media-item:first").html(e);if(t instanceof Object&&(t=t.name.split(".").pop()),this.hasUpload)return;const i=/\d+$/.exec(e);this.window.jQuery("#post_content").val(`\x3c!-- WPDR ${i} --\x3e`),this.window.jQuery("#message").hide(),this.hasUpload=!0,this.window.tb_remove(),this.window.jQuery("#post").before(wp_document_revisions.postUploadNotice).prev().fadeIn().fadeOut().fadeIn(),this.enableSubmit(),0!==this.window.jQuery("#sample-permalink").length&&this.window.jQuery("#sample-permalink").html(this.window.jQuery("#sample-permalink").html().replace(/\<\/span>(\.[a-z0-9]{1,7})?@$/i,wp_document_revisions.extension))}checkUpdate(){const t=this.$("#curr_content").val();if(void 0===t)return;const e=this.$("#post_content").val();if("Unset"===t)return this.$(":button, :submit","#submitpost").prop("disabled",!0),void this.$("#curr_content").val(e);this.getDescr()===t&&e===t||(this.buildContent(),this.enableSubmit())}}jQuery(e=>{window.WPDocumentRevisions=new t(e)})}();